<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Invoicebillers ‚Äì My Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
    :root{
      --green:#25D366;--green-dark:#128C7E;--black:#0a0a0a;
      --surface:#111413;--surface2:#1a1e1c;--border:rgba(37,211,102,0.15);
      --text:#e8ede9;--muted:#7a8c7e;--red:#ff4d4d;--yellow:#f5a623;
      --font-head:'Syne',sans-serif;--font-body:'DM Sans',sans-serif;
    }
    body{background:var(--black);color:var(--text);font-family:var(--font-body);min-height:100vh;}

    /* LAYOUT */
    .layout{display:flex;min-height:100vh;}

    /* SIDEBAR */
    .sidebar{
      width:240px;background:var(--surface);border-right:1px solid var(--border);
      padding:1.5rem 1rem;display:flex;flex-direction:column;gap:0.4rem;
      position:fixed;top:0;bottom:0;left:0;overflow-y:auto;z-index:50;
    }
    .sidebar-logo{font-family:var(--font-head);font-weight:800;font-size:1rem;color:#fff;padding:0.5rem 0.8rem;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem;}
    .sidebar-logo span{width:28px;height:28px;background:var(--green);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.8rem;}
    .user-info{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:0.9rem;margin-bottom:1rem;}
    .user-info .uname{font-weight:700;font-size:0.88rem;color:#fff;}
    .user-info .ushop{font-size:0.75rem;color:var(--green);margin-top:0.15rem;}
    .user-info .uemail{font-size:0.72rem;color:var(--muted);margin-top:0.1rem;}
    .nav-item{display:flex;align-items:center;gap:0.7rem;padding:0.65rem 0.8rem;border-radius:10px;cursor:pointer;font-size:0.88rem;font-weight:500;color:var(--muted);transition:all 0.2s;border:none;background:none;width:100%;text-align:left;}
    .nav-item:hover,.nav-item.active{background:rgba(37,211,102,0.1);color:var(--green);}
    .sidebar-bottom{margin-top:auto;}
    .logout-btn{display:flex;align-items:center;gap:0.7rem;padding:0.65rem 0.8rem;border-radius:10px;cursor:pointer;font-size:0.88rem;color:var(--red);border:none;background:none;width:100%;}
    .logout-btn:hover{background:rgba(255,77,77,0.1);}

    /* MAIN */
    .main{margin-left:240px;flex:1;padding:2rem;max-width:calc(100vw - 240px);}
    .page{display:none;}
    .page.active{display:block;}

    /* TOP BAR */
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;flex-wrap:wrap;gap:1rem;}
    .topbar h2{font-family:var(--font-head);font-size:1.6rem;font-weight:800;}
    .topbar p{color:var(--muted);font-size:0.85rem;}

    /* STAT CARDS */
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:1rem;margin-bottom:2rem;}
    .stat-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:1.3rem;}
    .stat-card .num{font-family:var(--font-head);font-size:1.8rem;font-weight:800;}
    .stat-card .num.green{color:var(--green);}
    .stat-card .num.yellow{color:var(--yellow);}
    .stat-card .num.red{color:var(--red);}
    .stat-card .lbl{color:var(--muted);font-size:0.78rem;margin-top:0.2rem;}

    /* INVOICE TABLE */
    .card{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;}
    .card-head{padding:1.2rem 1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.8rem;}
    .card-head h3{font-family:var(--font-head);font-size:1rem;font-weight:700;}
    table{width:100%;border-collapse:collapse;}
    th{padding:0.85rem 1.2rem;text-align:left;font-size:0.75rem;color:var(--muted);font-weight:600;letter-spacing:0.05em;text-transform:uppercase;background:var(--surface2);}
    td{padding:0.9rem 1.2rem;font-size:0.85rem;border-bottom:1px solid var(--border);}
    tr:last-child td{border-bottom:none;}
    tr:hover td{background:rgba(37,211,102,0.03);}
    .inv-status{padding:0.25rem 0.7rem;border-radius:100px;font-size:0.72rem;font-weight:600;}
    .inv-paid{background:rgba(37,211,102,0.15);color:var(--green);}
    .inv-pending{background:rgba(245,166,35,0.15);color:var(--yellow);}
    .inv-overdue{background:rgba(255,77,77,0.15);color:var(--red);}
    .inv-num{color:var(--green);font-weight:600;font-size:0.82rem;}
    .action-btn{background:rgba(37,211,102,0.1);color:var(--green);border:none;padding:0.3rem 0.7rem;border-radius:7px;cursor:pointer;font-size:0.75rem;}
    .empty-state{text-align:center;padding:3rem;color:var(--muted);}

    /* CREATE INVOICE FORM */
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
    @media(max-width:600px){.form-grid{grid-template-columns:1fr;}}
    .form-full{grid-column:1/-1;}
    .field label{font-size:0.78rem;color:var(--muted);display:block;margin-bottom:0.35rem;}
    .field input,.field select,.field textarea{
      width:100%;background:var(--surface2);border:1px solid var(--border);
      border-radius:10px;padding:0.7rem 1rem;color:var(--text);
      font-family:var(--font-body);font-size:0.88rem;outline:none;resize:vertical;
    }
    .field input:focus,.field select:focus,.field textarea:focus{border-color:rgba(37,211,102,0.5);}
    .items-section{margin-top:1rem;}
    .items-section h4{font-family:var(--font-head);font-size:0.9rem;font-weight:700;margin-bottom:0.8rem;color:#fff;}
    .item-row{display:grid;grid-template-columns:2fr 1fr 1fr auto;gap:0.7rem;margin-bottom:0.6rem;align-items:end;}
    @media(max-width:500px){.item-row{grid-template-columns:1fr 1fr;}}
    .btn-add-item{background:rgba(37,211,102,0.1);color:var(--green);border:1px solid var(--border);padding:0.5rem 1rem;border-radius:8px;cursor:pointer;font-size:0.82rem;font-family:var(--font-body);}
    .btn-del-item{background:rgba(255,77,77,0.1);color:var(--red);border:none;padding:0.5rem 0.7rem;border-radius:8px;cursor:pointer;font-size:0.85rem;}
    .invoice-total{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:1rem 1.2rem;margin-top:1rem;display:flex;justify-content:space-between;align-items:center;}
    .invoice-total .total-label{color:var(--muted);font-size:0.85rem;}
    .invoice-total .total-num{font-family:var(--font-head);font-size:1.5rem;font-weight:800;color:var(--green);}
    .btn-green{background:var(--green);color:#0a0a0a;border:none;padding:0.85rem 2rem;border-radius:100px;font-weight:700;font-size:0.92rem;cursor:pointer;font-family:var(--font-body);}
    .btn-outline{background:transparent;color:var(--text);border:1px solid var(--border);padding:0.85rem 1.5rem;border-radius:100px;font-size:0.88rem;cursor:pointer;font-family:var(--font-body);}

    /* INVOICE PREVIEW */
    #previewBox{
      display:none;background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:2rem;margin-top:1.5rem;
    }
    .preview-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem;}
    .preview-inv-num{font-family:var(--font-head);font-size:1.3rem;font-weight:800;color:var(--green);}
    .preview-table{width:100%;border-collapse:collapse;margin:1rem 0;}
    .preview-table th{background:var(--surface2);padding:0.7rem 1rem;text-align:left;font-size:0.78rem;color:var(--muted);font-weight:600;}
    .preview-table td{padding:0.7rem 1rem;border-bottom:1px solid var(--border);font-size:0.85rem;}
    .preview-total-row{display:flex;justify-content:flex-end;gap:2rem;padding-top:1rem;border-top:1px solid var(--border);}
    .preview-total-row .pt-label{color:var(--muted);font-size:0.85rem;}
    .preview-total-row .pt-val{font-family:var(--font-head);font-size:1.1rem;font-weight:800;color:var(--green);}

    /* TOAST */
    #dashToast{display:none;position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);padding:0.8rem 1.8rem;border-radius:100px;font-weight:600;font-size:0.88rem;z-index:3000;white-space:nowrap;}

    @media(max-width:768px){.sidebar{width:200px;} .main{margin-left:200px;}}
    @media(max-width:580px){.sidebar{display:none;} .main{margin-left:0;max-width:100vw;}}
  </style>
</head>
<body>

<div class="layout">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-logo"><span>üì≤</span> Invoicebillers</div>
    <div class="user-info">
      <div class="uname" id="sidebarName">‚Äî</div>
      <div class="ushop" id="sidebarShop">‚Äî</div>
      <div class="uemail" id="sidebarEmail">‚Äî</div>
    </div>
    <button class="nav-item active" onclick="showPage('dashboard',this)">üìä Dashboard</button>
    <button class="nav-item" onclick="showPage('invoices',this)">üìã My Invoices</button>
    <button class="nav-item" onclick="showPage('create',this)">‚ûï Create Invoice</button>
    <button class="nav-item" onclick="showPage('profile',this)">üë§ My Profile</button>
    <div class="sidebar-bottom">
      <button class="logout-btn" onclick="logout()">üö™ Logout</button>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">

    <!-- DASHBOARD PAGE -->
    <div id="page-dashboard" class="page active">
      <div class="topbar">
        <div>
          <h2>Welcome back, <span id="welcomeName">‚Äî</span> üëã</h2>
          <p>Here's your billing overview</p>
        </div>
        <button class="btn-green" onclick="showPage('create', document.querySelectorAll('.nav-item')[2])">‚ûï New Invoice</button>
      </div>
      <div class="stats">
        <div class="stat-card"><div class="num green" id="dTotalRev">$0</div><div class="lbl">üí∞ Total Revenue</div></div>
        <div class="stat-card"><div class="num" id="dTotalInv">0</div><div class="lbl">üìã Total Invoices</div></div>
        <div class="stat-card"><div class="num yellow" id="dPending">0</div><div class="lbl">‚è≥ Pending</div></div>
        <div class="stat-card"><div class="num red" id="dOverdue">0</div><div class="lbl">üî¥ Overdue</div></div>
      </div>
      <div class="card">
        <div class="card-head"><h3>üìã Recent Invoices</h3></div>
        <div id="recentInvoices"><div class="empty-state">No invoices yet. <a href="#" onclick="showPage('create',document.querySelectorAll('.nav-item')[2]);return false;" style="color:var(--green)">Create one ‚Üí</a></div></div>
      </div>
    </div>

    <!-- INVOICES PAGE -->
    <div id="page-invoices" class="page">
      <div class="topbar">
        <div><h2>My Invoices</h2><p>All your invoices in one place</p></div>
        <button class="btn-green" onclick="showPage('create', document.querySelectorAll('.nav-item')[2])">‚ûï New Invoice</button>
      </div>
      <div class="card">
        <div class="card-head">
          <h3>All Invoices</h3>
          <div style="display:flex;gap:0.5rem;">
            <select id="invFilter" onchange="renderInvoiceTable()" style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:0.4rem 0.8rem;color:var(--text);font-family:var(--font-body);font-size:0.82rem;outline:none;">
              <option value="all">All Status</option>
              <option value="paid">Paid</option>
              <option value="pending">Pending</option>
              <option value="overdue">Overdue</option>
            </select>
          </div>
        </div>
        <div id="invoiceTableWrap"></div>
      </div>
    </div>

    <!-- CREATE INVOICE PAGE -->
    <div id="page-create" class="page">
      <div class="topbar"><div><h2>Create Invoice</h2><p>Fill in the details below</p></div></div>
      <div class="card" style="padding:1.5rem;">
        <form onsubmit="createInvoice(event)">
          <!-- Client Details -->
          <h3 style="font-family:var(--font-head);font-size:1rem;font-weight:700;margin-bottom:1rem;color:var(--green);">üë§ Client Details</h3>
          <div class="form-grid">
            <div class="field"><label>Client Name *</label><input type="text" id="cliName" required placeholder="John Smith"/></div>
            <div class="field"><label>Client Email</label><input type="email" id="cliEmail" placeholder="john@example.com"/></div>
            <div class="field"><label>Client Phone</label><input type="tel" id="cliPhone" placeholder="+1 234 567 8900"/></div>
            <div class="field"><label>Due Date *</label><input type="date" id="dueDate" required/></div>
            <div class="field form-full"><label>Notes / Description</label><textarea id="invNotes" rows="2" placeholder="Any additional notes..."></textarea></div>
          </div>

          <!-- Items -->
          <div class="items-section">
            <h3 style="font-family:var(--font-head);font-size:1rem;font-weight:700;margin-bottom:1rem;margin-top:1.5rem;color:var(--green);">üì¶ Invoice Items</h3>
            <div id="itemRows">
              <div class="item-row">
                <div class="field"><label>Item Description</label><input type="text" class="iDesc" placeholder="Web Design" required/></div>
                <div class="field"><label>Qty</label><input type="number" class="iQty" value="1" min="1" oninput="calcTotal()"/></div>
                <div class="field"><label>Unit Price ($)</label><input type="number" class="iPrice" placeholder="100" min="0" step="0.01" oninput="calcTotal()"/></div>
                <div class="field"><label>&nbsp;</label><button type="button" class="btn-del-item" onclick="removeItem(this)">üóë</button></div>
              </div>
            </div>
            <button type="button" class="btn-add-item" onclick="addItem()">+ Add Item</button>
          </div>

          <!-- Total -->
          <div class="invoice-total">
            <div class="total-label">Invoice Total</div>
            <div class="total-num" id="invTotal">$0.00</div>
          </div>

          <!-- Actions -->
          <div style="display:flex;gap:1rem;margin-top:1.5rem;flex-wrap:wrap;">
            <button type="button" class="btn-outline" onclick="previewInvoice()">üëÅ Preview</button>
            <button type="submit" class="btn-green">üíæ Save Invoice</button>
            <button type="button" class="btn-outline" onclick="shareWhatsApp()">üì≤ Send via WhatsApp</button>
          </div>
        </form>

        <!-- PREVIEW -->
        <div id="previewBox">
          <div class="preview-header">
            <div>
              <div class="preview-inv-num" id="prevNum"></div>
              <div style="color:var(--muted);font-size:0.82rem;margin-top:0.3rem;">Date: <span id="prevDate"></span> | Due: <span id="prevDue"></span></div>
            </div>
            <div style="text-align:right;">
              <div style="font-family:var(--font-head);font-weight:800;font-size:1.1rem;" id="prevShop"></div>
              <div style="color:var(--muted);font-size:0.78rem;" id="prevOwner"></div>
            </div>
          </div>
          <div style="margin-bottom:1rem;padding:0.8rem 1rem;background:var(--surface2);border-radius:10px;">
            <div style="font-weight:600;font-size:0.9rem;" id="prevClient"></div>
            <div style="color:var(--muted);font-size:0.78rem;margin-top:0.15rem;" id="prevClientContact"></div>
          </div>
          <table class="preview-table">
            <thead><tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead>
            <tbody id="prevItems"></tbody>
          </table>
          <div class="preview-total-row">
            <span class="pt-label">Total Amount:</span>
            <span class="pt-val" id="prevTotal"></span>
          </div>
          <div style="color:var(--muted);font-size:0.78rem;margin-top:1rem;" id="prevNotes"></div>
        </div>
      </div>
    </div>

    <!-- PROFILE PAGE -->
    <div id="page-profile" class="page">
      <div class="topbar"><div><h2>My Profile</h2><p>Your account details</p></div></div>
      <div class="card" style="padding:1.5rem;max-width:500px;">
        <div style="display:flex;align-items:center;gap:1.2rem;margin-bottom:1.5rem;padding-bottom:1.5rem;border-bottom:1px solid var(--border);">
          <div style="width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#128C7E,#25D366);display:flex;align-items:center;justify-content:center;font-size:1.4rem;font-weight:700;color:#0a0a0a;" id="profileAvatar">‚Äî</div>
          <div>
            <div style="font-family:var(--font-head);font-size:1.1rem;font-weight:700;" id="profileName">‚Äî</div>
            <div style="color:var(--green);font-size:0.82rem;" id="profileShop">‚Äî</div>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:0.9rem;">
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:0.9rem 1rem;">
            <div style="font-size:0.72rem;color:var(--muted);margin-bottom:0.2rem;">üìß Email</div>
            <div style="font-size:0.9rem;" id="profileEmail">‚Äî</div>
          </div>
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:0.9rem 1rem;">
            <div style="font-size:0.72rem;color:var(--muted);margin-bottom:0.2rem;">üì± Mobile / WhatsApp</div>
            <div style="font-size:0.9rem;" id="profilePhone">‚Äî</div>
          </div>
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:0.9rem 1rem;">
            <div style="font-size:0.72rem;color:var(--muted);margin-bottom:0.2rem;">üíº Business Type</div>
            <div style="font-size:0.9rem;" id="profileBiz">‚Äî</div>
          </div>
          <div style="background:rgba(37,211,102,0.08);border:1px solid var(--border);border-radius:12px;padding:0.9rem 1rem;">
            <div style="font-size:0.72rem;color:var(--muted);margin-bottom:0.2rem;">‚úÖ Account Status</div>
            <div style="font-size:0.9rem;color:var(--green);font-weight:600;">Approved & Active</div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /main -->
</div><!-- /layout -->

<div id="dashToast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp, orderBy }
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üîß PASTE YOUR FIREBASE CONFIG BELOW
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   const firebaseConfig = {
  apiKey: "AIzaSyAaAtC56I7n5D8JTJEOdBZNnFnQktIz96k",
  authDomain: "invoicebillers.firebaseapp.com",
  projectId: "invoicebillers",
  storageBucket: "invoicebillers.firebasestorage.app",
  messagingSenderId: "921352095208",
  appId: "1:921352095208:web:e1841dbdb7cfba1c74105d"
};

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // ‚îÄ‚îÄ AUTH GUARD ‚îÄ‚îÄ
  const raw = sessionStorage.getItem('ib_user');
  if (!raw) { window.location.href = 'index.html'; }
  const user = JSON.parse(raw);

  // Fill sidebar & profile
  document.getElementById('sidebarName').textContent  = user.name || '‚Äî';
  document.getElementById('sidebarShop').textContent  = 'üè™ ' + (user.shop || '‚Äî');
  document.getElementById('sidebarEmail').textContent = user.email || '‚Äî';
  document.getElementById('welcomeName').textContent  = user.name?.split(' ')[0] || 'there';
  document.getElementById('profileName').textContent  = user.name || '‚Äî';
  document.getElementById('profileShop').textContent  = 'üè™ ' + (user.shop || '‚Äî');
  document.getElementById('profileEmail').textContent = user.email || '‚Äî';
  document.getElementById('profilePhone').textContent = user.phone || '‚Äî';
  document.getElementById('profileBiz').textContent   = user.biz   || '‚Äî';
  const initials = (user.name||'?').split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
  document.getElementById('profileAvatar').textContent = initials;

  // ‚îÄ‚îÄ LOAD INVOICES ‚îÄ‚îÄ
  let invoices = [];

  async function loadInvoices() {
    try {
      const q = query(collection(db,'invoices'), where('userId','==', user.id), orderBy('createdAt','desc'));
      const snap = await getDocs(q);
      invoices = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      updateDashboardStats();
      renderRecentInvoices();
      renderInvoiceTable();
    } catch(e) { console.error(e); }
  }

  function updateDashboardStats() {
    const paid    = invoices.filter(i=>i.status==='paid').reduce((s,i)=>s+i.total,0);
    const pending = invoices.filter(i=>i.status==='pending').length;
    const overdue = invoices.filter(i=>i.status==='overdue').length;
    document.getElementById('dTotalRev').textContent = '$' + paid.toFixed(2);
    document.getElementById('dTotalInv').textContent = invoices.length;
    document.getElementById('dPending').textContent  = pending;
    document.getElementById('dOverdue').textContent  = overdue;
  }

  function invRowHtml(inv) {
    const sc = {paid:'inv-paid',pending:'inv-pending',overdue:'inv-overdue'}[inv.status]||'';
    return `<tr>
      <td><span class="inv-num">${inv.invNum||'‚Äî'}</span></td>
      <td>${inv.clientName||'‚Äî'}</td>
      <td>${inv.dueDate||'‚Äî'}</td>
      <td>$${(inv.total||0).toFixed(2)}</td>
      <td><span class="inv-status ${sc}">${inv.status||'‚Äî'}</span></td>
    </tr>`;
  }

  function renderRecentInvoices() {
    const el = document.getElementById('recentInvoices');
    const recent = invoices.slice(0,5);
    if (!recent.length) { el.innerHTML = `<div class="empty-state">No invoices yet. <a href="#" onclick="showPage('create',document.querySelectorAll('.nav-item')[2]);return false;" style="color:var(--green)">Create one ‚Üí</a></div>`; return; }
    el.innerHTML = `<table><thead><tr><th>Invoice #</th><th>Client</th><th>Due</th><th>Amount</th><th>Status</th></tr></thead><tbody>${recent.map(invRowHtml).join('')}</tbody></table>`;
  }

  window.renderInvoiceTable = function() {
    const filter = document.getElementById('invFilter')?.value || 'all';
    const filtered = filter==='all' ? invoices : invoices.filter(i=>i.status===filter);
    const el = document.getElementById('invoiceTableWrap');
    if (!filtered.length) { el.innerHTML=`<div class="empty-state">No ${filter==='all'?'':filter} invoices.</div>`; return; }
    el.innerHTML = `<table><thead><tr><th>Invoice #</th><th>Client</th><th>Due Date</th><th>Amount</th><th>Status</th></tr></thead><tbody>${filtered.map(invRowHtml).join('')}</tbody></table>`;
  };

  // ‚îÄ‚îÄ CREATE INVOICE ‚îÄ‚îÄ
  let invCounter = 1;

  window.createInvoice = async function(e) {
    e.preventDefault();
    const items = getItems();
    if (!items.length) { showDashToast('‚ùå Add at least one item.','#ff4d4d','#fff'); return; }
    const total = items.reduce((s,i)=>s+i.qty*i.price,0);
    const invNum = `INV-${String(invoices.length+1).padStart(4,'0')}`;

    const inv = {
      userId: user.id,
      invNum,
      clientName: document.getElementById('cliName').value.trim(),
      clientEmail: document.getElementById('cliEmail').value.trim(),
      clientPhone: document.getElementById('cliPhone').value.trim(),
      dueDate: document.getElementById('dueDate').value,
      notes: document.getElementById('invNotes').value.trim(),
      items, total,
      status: 'pending',
      createdAt: serverTimestamp()
    };

    try {
      const ref = await addDoc(collection(db,'invoices'), inv);
      inv.id = ref.id;
      invoices.unshift(inv);
      updateDashboardStats();
      renderRecentInvoices();
      renderInvoiceTable();
      showDashToast('‚úÖ Invoice ' + invNum + ' saved!', '#25D366', '#0a0a0a');
      e.target.reset(); calcTotal();
      document.getElementById('previewBox').style.display='none';
    } catch(err) {
      showDashToast('‚ùå Error: ' + err.message, '#ff4d4d', '#fff');
    }
  };

  window.logout = function() {
    sessionStorage.removeItem('ib_user');
    window.location.href = 'index.html';
  };

  loadInvoices();
</script>

<script>
  // ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ
  function showPage(name, btn) {
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
    document.getElementById('page-'+name).classList.add('active');
    if(btn) btn.classList.add('active');
    if(name==='invoices') renderInvoiceTable();
  }
  window.showPage = showPage;

  // ‚îÄ‚îÄ ITEMS ‚îÄ‚îÄ
  function addItem() {
    const row = document.createElement('div');
    row.className = 'item-row';
    row.innerHTML = `
      <div class="field"><label>Item Description</label><input type="text" class="iDesc" placeholder="Item" required/></div>
      <div class="field"><label>Qty</label><input type="number" class="iQty" value="1" min="1" oninput="calcTotal()"/></div>
      <div class="field"><label>Unit Price ($)</label><input type="number" class="iPrice" placeholder="100" min="0" step="0.01" oninput="calcTotal()"/></div>
      <div class="field"><label>&nbsp;</label><button type="button" class="btn-del-item" onclick="removeItem(this)">üóë</button></div>`;
    document.getElementById('itemRows').appendChild(row);
  }
  window.addItem = addItem;

  function removeItem(btn) {
    const rows = document.querySelectorAll('#itemRows .item-row');
    if(rows.length<=1){return;}
    btn.closest('.item-row').remove();
    calcTotal();
  }
  window.removeItem = removeItem;

  function getItems() {
    const descs  = [...document.querySelectorAll('.iDesc')];
    const qtys   = [...document.querySelectorAll('.iQty')];
    const prices = [...document.querySelectorAll('.iPrice')];
    return descs.map((d,i)=>({
      desc: d.value.trim(),
      qty: parseFloat(qtys[i].value)||1,
      price: parseFloat(prices[i].value)||0
    })).filter(i=>i.desc);
  }
  window.getItems = getItems;

  function calcTotal() {
    const total = getItems().reduce((s,i)=>s+i.qty*i.price,0);
    document.getElementById('invTotal').textContent = '$'+total.toFixed(2);
  }
  window.calcTotal = calcTotal;

  // ‚îÄ‚îÄ PREVIEW ‚îÄ‚îÄ
  function previewInvoice() {
    const items = getItems();
    const user  = JSON.parse(sessionStorage.getItem('ib_user')||'{}');
    const invNum= `INV-PREVIEW`;
    const total = items.reduce((s,i)=>s+i.qty*i.price,0);
    document.getElementById('prevNum').textContent  = invNum;
    document.getElementById('prevDate').textContent = new Date().toLocaleDateString();
    document.getElementById('prevDue').textContent  = document.getElementById('dueDate').value||'‚Äî';
    document.getElementById('prevShop').textContent = user.shop||'Your Shop';
    document.getElementById('prevOwner').textContent= user.name||'‚Äî';
    document.getElementById('prevClient').textContent= document.getElementById('cliName').value||'Client Name';
    document.getElementById('prevClientContact').textContent= document.getElementById('cliEmail').value + ' | ' + document.getElementById('cliPhone').value;
    document.getElementById('prevItems').innerHTML = items.map(i=>`<tr><td>${i.desc}</td><td>${i.qty}</td><td>$${i.price.toFixed(2)}</td><td>$${(i.qty*i.price).toFixed(2)}</td></tr>`).join('');
    document.getElementById('prevTotal').textContent='$'+total.toFixed(2);
    document.getElementById('prevNotes').textContent= document.getElementById('invNotes').value ? 'üìù '+document.getElementById('invNotes').value : '';
    const box = document.getElementById('previewBox');
    box.style.display = box.style.display==='none'?'block':'none';
  }
  window.previewInvoice = previewInvoice;

  // ‚îÄ‚îÄ WHATSAPP SHARE ‚îÄ‚îÄ
  function shareWhatsApp() {
    const user  = JSON.parse(sessionStorage.getItem('ib_user')||'{}');
    const items = getItems();
    const total = items.reduce((s,i)=>s+i.qty*i.price,0);
    const client= document.getElementById('cliName').value||'Client';
    const phone = document.getElementById('cliPhone').value.replace(/\D/g,'');
    let msg = `*Invoice from ${user.shop||'Invoicebillers'}*\n\nDear ${client},\n\n`;
    items.forEach(i=>{ msg+=`‚Ä¢ ${i.desc} x${i.qty} = $${(i.qty*i.price).toFixed(2)}\n`; });
    msg+=`\n*Total: $${total.toFixed(2)}*\nDue: ${document.getElementById('dueDate').value||'ASAP'}\n\nThank you! üôè`;
    const url = phone ? `https://wa.me/${phone}?text=${encodeURIComponent(msg)}` : `https://wa.me/?text=${encodeURIComponent(msg)}`;
    window.open(url,'_blank');
  }
  window.shareWhatsApp = shareWhatsApp;

  function showDashToast(msg,bg,color){
    const t=document.getElementById('dashToast');
    t.textContent=msg;t.style.background=bg;t.style.color=color;t.style.display='block';
    setTimeout(()=>{t.style.display='none';},4000);
  }
</script>
</body>
</html>
